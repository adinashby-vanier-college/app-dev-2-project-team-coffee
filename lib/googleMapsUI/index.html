<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Google Maps UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="osmParser.js"></script>
    <script src="osmRenderer.jsx"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        touch-action: none;
      }
      #root {
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }
      @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .animate-slide-up {
        animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes slide-up-sm {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-slide-up-sm {
         animation: slide-up-sm 0.2s ease-out;
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <script type="text/javascript">
// ============================================================================
// LOCATIONS.JS - Location Database
// ============================================================================
window.LOCATION_DATABASE = [
  {
    id: 'mtl-mount-royal',
    name: 'Mount Royal Park',
    type: 'park',
    rating: 4.9,
    reviews: '45,000',
    price: 'Free',
    category: 'Park',
    address: 'Mount Royal',
    openStatus: 'Open',
    closeTime: '11 PM',
    distance: '1.2 km',
    coordinates: { x: 1100, y: 1000 },
    description: 'Iconic mountain park offering panoramic views of the city, walking trails, and the famous cross.',
    hours: [
      { day: 'Monday', time: '6:00 AM – 11:00 PM' },
      { day: 'Tuesday', time: '6:00 AM – 11:00 PM' },
      { day: 'Wednesday', time: '6:00 AM – 11:00 PM' },
      { day: 'Thursday', time: '6:00 AM – 11:00 PM' },
      { day: 'Friday', time: '6:00 AM – 11:00 PM' },
      { day: 'Saturday', time: '6:00 AM – 11:00 PM' },
      { day: 'Sunday', time: '6:00 AM – 11:00 PM' }
    ]
  },
  {
    id: 'mtl-schwartz',
    name: "Schwartz's Deli",
    type: 'restaurant',
    rating: 4.6,
    reviews: '18,421',
    price: '$$',
    category: 'Deli',
    address: '3895 St Laurent Blvd',
    openStatus: 'Open',
    closeTime: '11 PM',
    distance: '2.2 km',
    coordinates: { x: 1520, y: 1300 },
    description: 'The institution. Smoked meat, cherry coke, pickles.',
    hours: [
      { day: 'Monday', time: '11:00 AM – 11:00 PM' },
      { day: 'Tuesday', time: '11:00 AM – 11:00 PM' },
      { day: 'Wednesday', time: '11:00 AM – 11:00 PM' },
      { day: 'Thursday', time: '11:00 AM – 11:00 PM' },
      { day: 'Friday', time: '11:00 AM – 11:00 PM' },
      { day: 'Saturday', time: '11:00 AM – 11:00 PM' },
      { day: 'Sunday', time: '11:00 AM – 11:00 PM' }
    ]
  },
  {
    id: 'mtl-notre-dame',
    name: 'Notre-Dame Basilica',
    type: 'landmark',
    rating: 4.9,
    reviews: '35,000',
    price: '$$',
    category: 'Basilica',
    address: '110 Notre-Dame St W',
    openStatus: 'Closes soon',
    closeTime: '4:30 PM',
    distance: '1.8 km',
    coordinates: { x: 1600, y: 2200 },
    description: 'Gothic Revival masterpiece with stunning interior.',
    hours: [
      { day: 'Monday', time: '9:00 AM – 4:30 PM' },
      { day: 'Tuesday', time: '9:00 AM – 4:30 PM' },
      { day: 'Wednesday', time: '9:00 AM – 4:30 PM' },
      { day: 'Thursday', time: '9:00 AM – 4:30 PM' },
      { day: 'Friday', time: '9:00 AM – 4:30 PM' },
      { day: 'Saturday', time: '9:00 AM – 4:30 PM' },
      { day: 'Sunday', time: '9:00 AM – 4:30 PM' }
    ]
  },
  {
    id: 'mtl-mcgill',
    name: 'McGill University',
    type: 'landmark',
    rating: 4.8,
    reviews: '15,000',
    price: 'Free',
    category: 'University',
    address: '845 Sherbrooke St W',
    openStatus: 'Open',
    closeTime: '',
    distance: '0.8 km',
    coordinates: { x: 1050, y: 1650 },
    description: 'Prestigious university with beautiful historic campus.',
    hours: [{ day: 'Monday', time: '24 Hours' }]
  },
  {
    id: 'mtl-dieu-du-ciel',
    name: 'Dieu du Ciel!',
    type: 'bar',
    rating: 4.8,
    reviews: '4,500',
    price: '$$',
    category: 'Microbrewery',
    address: '29 Laurier Ave W',
    openStatus: 'Open',
    closeTime: '3 AM',
    distance: '3.5 km',
    coordinates: { x: 1400, y: 950 },
    description: 'Legendary craft brewery with exceptional Belgian-style beers.',
    hours: [
      { day: 'Monday', time: '3:00 PM – 3:00 AM' },
      { day: 'Tuesday', time: '3:00 PM – 3:00 AM' },
      { day: 'Wednesday', time: '3:00 PM – 3:00 AM' },
      { day: 'Thursday', time: '3:00 PM – 3:00 AM' },
      { day: 'Friday', time: '3:00 PM – 3:00 AM' },
      { day: 'Saturday', time: '3:00 PM – 3:00 AM' },
      { day: 'Sunday', time: '3:00 PM – 3:00 AM' }
    ]
  },
  {
    id: 'mtl-st-viateur',
    name: 'St-Viateur Bagel',
    type: 'food',
    rating: 4.9,
    reviews: '15,600',
    price: '$',
    category: 'Bakery',
    address: '263 Rue Saint-Viateur O',
    openStatus: 'Open 24 hours',
    closeTime: '',
    distance: '3.8 km',
    coordinates: { x: 1350, y: 850 },
    description: 'The 24/7 wood-fired bagel temple.',
    hours: [
      { day: 'Monday', time: '24 Hours' },
      { day: 'Tuesday', time: '24 Hours' },
      { day: 'Wednesday', time: '24 Hours' },
      { day: 'Thursday', time: '24 Hours' },
      { day: 'Friday', time: '24 Hours' },
      { day: 'Saturday', time: '24 Hours' },
      { day: 'Sunday', time: '24 Hours' }
    ]
  },
  {
    id: 'mtl-parc-lafontaine',
    name: 'Parc La Fontaine',
    type: 'park',
    rating: 4.8,
    reviews: '12,000',
    price: 'Free',
    category: 'Park',
    address: 'Plateau-Mont-Royal',
    openStatus: 'Open',
    closeTime: '11 PM',
    distance: '3.0 km',
    coordinates: { x: 2000, y: 1400 },
    description: 'The big park. Duck ponds and summer theater.',
    hours: [
      { day: 'Monday', time: '6:00 AM – 11:00 PM' },
      { day: 'Tuesday', time: '6:00 AM – 11:00 PM' },
      { day: 'Wednesday', time: '6:00 AM – 11:00 PM' },
      { day: 'Thursday', time: '6:00 AM – 11:00 PM' },
      { day: 'Friday', time: '6:00 AM – 11:00 PM' },
      { day: 'Saturday', time: '6:00 AM – 11:00 PM' },
      { day: 'Sunday', time: '6:00 AM – 11:00 PM' }
    ]
  },
  {
    id: 'mtl-place-ville-marie',
    name: 'Place Ville Marie',
    type: 'landmark',
    rating: 4.6,
    reviews: '2,000',
    price: 'Free',
    category: 'Office Tower',
    address: '1 Place Ville Marie',
    openStatus: 'Open',
    closeTime: '6 PM',
    distance: '0.4 km',
    coordinates: { x: 1200, y: 1950 },
    description: 'Iconic cruciform tower defining the skyline.',
    hours: [
      { day: 'Monday', time: '9:00 AM – 6:00 PM' },
      { day: 'Tuesday', time: '9:00 AM – 6:00 PM' },
      { day: 'Wednesday', time: '9:00 AM – 6:00 PM' },
      { day: 'Thursday', time: '9:00 AM – 6:00 PM' },
      { day: 'Friday', time: '9:00 AM – 6:00 PM' },
      { day: 'Saturday', time: '10:00 AM – 5:00 PM' },
      { day: 'Sunday', time: 'Closed' }
    ]
  }
];
    </script>

    <script type="text/javascript">
// ============================================================================
// MAPSERVICE.JS - Utility Functions
// ============================================================================
window.MapService = window.MapService || {};
window.MapService.searchLocations = (locations, query) => {
  if (!query || query.trim() === '') {
    return [];
  }
  const searchTerm = query.toLowerCase().trim();
  return locations.filter(loc => 
    loc.name.toLowerCase().includes(searchTerm) || 
    loc.category.toLowerCase().includes(searchTerm) ||
    loc.type.toLowerCase().includes(searchTerm)
  );
};

window.MapService.calculateViewForLocation = (location, options = {}) => {
  const { 
    viewportWidth = 400,
    viewportHeight = 600,
    scale = 1 
  } = options;
  
  // Calculate viewport center
  const viewportCenterX = viewportWidth / 2;
  const viewportCenterY = viewportHeight / 2;
  
  // Center the location in the viewport
  return {
    x: viewportCenterX - (location.coordinates.x * scale),
    y: viewportCenterY - (location.coordinates.y * scale),
    scale: scale
  };
};

window.MapService.calculateZoom = (currentScale, direction, constraints = {}) => {
  const { min = 0.2, max = 3, factor = 1.5 } = constraints;
  if (direction === 'in') {
    return Math.min(currentScale * factor, max);
  } else {
    return Math.max(currentScale / factor, min);
  }
};

window.MapService.getMarkerColor = (type) => {
  const colorMap = {
    restaurant: 'bg-orange-500',
    food: 'bg-orange-500',
    bar: 'bg-purple-500',
    shop: 'bg-pink-500',
    hotel: 'bg-indigo-500',
    attraction: 'bg-teal-500',
    landmark: 'bg-teal-500',
    park: 'bg-green-600',
    default: 'bg-red-500'
  };
  return colorMap[type] || colorMap.default;
};

window.MapService.getMarkerBorderColor = (type) => {
  const colorMap = {
    restaurant: 'border-t-orange-500',
    food: 'border-t-orange-500',
    bar: 'border-t-purple-500',
    shop: 'border-t-pink-500',
    hotel: 'border-t-indigo-500',
    attraction: 'border-t-teal-500',
    landmark: 'border-t-teal-500',
    park: 'border-t-green-600',
    default: 'border-t-red-500'
  };
  return colorMap[type] || colorMap.default;
};

window.MapService.getDefaultViewState = (options = {}) => {
  const mapCanvasSize = 3000;
  const mapCenter = mapCanvasSize / 2;
  const scale = 0.5;
  
  if (options.viewportWidth && options.viewportHeight) {
    const viewportCenterX = options.viewportWidth / 2;
    const viewportCenterY = options.viewportHeight / 2;
    return {
      x: viewportCenterX - (mapCenter * scale),
      y: viewportCenterY - (mapCenter * scale),
      scale: scale
    };
  }
  
  return {
    x: 200 - (mapCenter * scale),
    y: 300 - (mapCenter * scale),
    scale: scale
  };
};
    </script>

    <!-- MapView.jsx - Inline JSX -->
    <script type="text/babel">
const { useState, useRef, useEffect } = React;

const Icon = ({ name, className, style }) => {
  const svgPaths = {
    MapPin: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z',
    Star: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',
    Clock: 'M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z M12 6v6l4 2',
    Phone: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z',
    Globe: 'M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 0 1 9-9',
    Share2: 'M18 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z M6 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z M13.5 10.5L18 8M13.5 13.5L18 16M6 13v-2',
    Bookmark: 'M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z',
    X: 'M18 6L6 18M6 6l12 12',
    Plus: 'M12 5v14m7-7H5',
    Minus: 'M5 12h14',
    Search: 'M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z',
    ChevronDown: 'M6 9l6 6 6-6',
    ChevronUp: 'M18 15l-6-6-6 6',
    Beer: 'M17 11v1a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-1M17 11V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2M17 11h2a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-2',
    Coffee: 'M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3',
    Utensils: 'M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3z',
    ShoppingBag: 'M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4zM3 6h18M16 10a4 4 0 0 1-8 0',
    Landmark: 'M3 21l9-9 9 9M12 3v18',
    Hotel: 'M18 2H6a2 2 0 0 0-2 2v18l4-4h8l4 4V4a2 2 0 0 0-2-2z',
    Train: 'M16 1H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM5 5h6M5 9h6M5 13h6',
    Compass: 'M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0zM12 2v20M17 7l-5 5-5-5'
  };
  const path = svgPaths[name] || '';
  return React.createElement('svg', {
    className,
    style: style || {},
    viewBox: '0 0 24 24',
    fill: 'none',
    stroke: 'currentColor',
    strokeWidth: 2,
    strokeLinecap: 'round',
    strokeLinejoin: 'round'
  }, React.createElement('path', { d: path }));
};

const MapPin = (props) => React.createElement(Icon, { ...props, name: 'MapPin' });
const Star = (props) => React.createElement(Icon, { ...props, name: 'Star' });
const Clock = (props) => React.createElement(Icon, { ...props, name: 'Clock' });
const Phone = (props) => React.createElement(Icon, { ...props, name: 'Phone' });
const Globe = (props) => React.createElement(Icon, { ...props, name: 'Globe' });
const Share2 = (props) => React.createElement(Icon, { ...props, name: 'Share2' });
const Bookmark = (props) => React.createElement(Icon, { ...props, name: 'Bookmark' });
const X = (props) => React.createElement(Icon, { ...props, name: 'X' });
const Plus = (props) => React.createElement(Icon, { ...props, name: 'Plus' });
const Minus = (props) => React.createElement(Icon, { ...props, name: 'Minus' });
const Search = (props) => React.createElement(Icon, { ...props, name: 'Search' });
const ChevronDown = (props) => React.createElement(Icon, { ...props, name: 'ChevronDown' });
const ChevronUp = (props) => React.createElement(Icon, { ...props, name: 'ChevronUp' });
const Beer = (props) => React.createElement(Icon, { ...props, name: 'Beer' });
const Coffee = (props) => React.createElement(Icon, { ...props, name: 'Coffee' });
const Utensils = (props) => React.createElement(Icon, { ...props, name: 'Utensils' });
const ShoppingBag = (props) => React.createElement(Icon, { ...props, name: 'ShoppingBag' });
const Landmark = (props) => React.createElement(Icon, { ...props, name: 'Landmark' });
const Hotel = (props) => React.createElement(Icon, { ...props, name: 'Hotel' });
const Train = (props) => React.createElement(Icon, { ...props, name: 'Train' });
const Compass = (props) => React.createElement(Icon, { ...props, name: 'Compass' });

const App = () => {
  const [selectedLocation, setSelectedLocation] = useState(null);
  // Initialize with a default that will be updated by useEffect
  const [viewState, setViewState] = useState(() => {
    // Use a reasonable default that works until useEffect runs
    return window.MapService.getDefaultViewState();
  });
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [isHoursExpanded, setIsHoursExpanded] = useState(false);
  const [hoveredLocationId, setHoveredLocationId] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [savedLocations, setSavedLocations] = useState(new Set());
  const [isSendSceneModalOpen, setIsSendSceneModalOpen] = useState(false);
  const [selectedFriends, setSelectedFriends] = useState(new Set());
  
  // OSM Data State
  const [osmData, setOsmData] = useState(null);
  const [osmSvgElements, setOsmSvgElements] = useState([]);
  const [isLoadingOSM, setIsLoadingOSM] = useState(true);

  const mapRef = useRef(null);
  const currentDay = new Date().toLocaleDateString('en-US', { weekday: 'long' });
  const touchStartRef = useRef(null);

  const friendsList = [
    { id: 1, name: 'Sarah Chen', avatar: 'SC' },
    { id: 2, name: 'Michael Torres', avatar: 'MT' },
    { id: 3, name: 'Emma Johnson', avatar: 'EJ' },
    { id: 4, name: 'David Kim', avatar: 'DK' },
    { id: 5, name: 'Olivia Martinez', avatar: 'OM' },
    { id: 6, name: 'James Wilson', avatar: 'JW' },
    { id: 7, name: 'Sophie Brown', avatar: 'SB' },
    { id: 8, name: 'Alex Rivera', avatar: 'AR' },
  ];

  useEffect(() => {
    if (mapRef.current) {
      const updateViewState = () => {
        const viewportWidth = mapRef.current.clientWidth || 400;
        const viewportHeight = mapRef.current.clientHeight || 600;
        if (viewportWidth > 0 && viewportHeight > 0) {
          const centeredViewState = window.MapService.getDefaultViewState({
            viewportWidth,
            viewportHeight
          });
          setViewState(centeredViewState);
        }
      };
      
      updateViewState();
      
      const resizeObserver = new ResizeObserver(updateViewState);
      resizeObserver.observe(mapRef.current);
      
      return () => resizeObserver.disconnect();
    }
  }, []);

  // Function to process OSM data (called from Flutter or directly)
  const processOSMData = (xmlText) => {
    try {
      if (!xmlText) {
        console.warn('No OSM data provided, map will render without OSM features');
        setIsLoadingOSM(false);
        return;
      }
      
      if (!window.OSMParser || !window.OSMRenderer) {
        throw new Error('OSM parser or renderer not loaded');
      }
      
      const parsed = window.OSMParser.parseOSM(xmlText);
      
      if (!parsed.bounds) {
        throw new Error('OSM file missing bounds');
      }
      
      setOsmData(parsed);
      
      // Categorize ways and render to SVG
      const categorized = window.OSMParser.categorizeWays(parsed.ways);
      const canvasWidth = 3000;
      const canvasHeight = 3000;
      const svgElements = window.OSMRenderer.renderOSMToSVG(categorized, parsed.nodes, parsed.bounds, canvasWidth, canvasHeight);
      setOsmSvgElements(svgElements);
      console.log('OSM data loaded successfully:', { ways: parsed.ways.length, nodes: parsed.nodes.size });
      setIsLoadingOSM(false);
    } catch (error) {
      console.error('Error processing OSM data:', error);
      // Set empty elements on error so map still renders
      setOsmSvgElements([]);
      setIsLoadingOSM(false);
    }
  };

  // Expose function for Flutter to call (with safety check)
  // Use a queue in case Flutter calls before React is ready
  window._osmDataQueue = window._osmDataQueue || [];
  window.loadOSMDataFromFlutter = (xmlText) => {
    if (typeof processOSMData === 'function') {
      processOSMData(xmlText);
    } else {
      // Queue the data if React isn't ready yet
      window._osmDataQueue.push(xmlText);
    }
  };

  // --- LOAD OSM DATA ---
  useEffect(() => {
    setIsLoadingOSM(true);
    // The OSM data will be loaded by Flutter via loadOSMDataFromFlutter
    // Check if there's queued data from before React was ready
    if (window._osmDataQueue && window._osmDataQueue.length > 0) {
      const queuedData = window._osmDataQueue.shift();
      processOSMData(queuedData);
    }
    // Set a timeout to stop loading state if no data arrives
    const timeout = setTimeout(() => {
      setIsLoadingOSM(prev => {
        if (prev) {
          console.warn('OSM data loading timeout, rendering map without OSM features');
          return false;
        }
        return prev;
      });
    }, 5000);
    return () => clearTimeout(timeout);
  }, []);

  useEffect(() => {
    const results = window.MapService.searchLocations(window.LOCATION_DATABASE, searchQuery);
    setSearchResults(results);
  }, [searchQuery]);

  // Load saved locations from Firebase when component mounts
  useEffect(() => {
    // Function to receive saved locations from Flutter
    window.loadSavedLocationsFromFlutter = (locationIds) => {
      setSavedLocations(new Set(locationIds));
    };
    
    // Request saved locations from Flutter
    if (window.FlutterGetSavedLocations) {
      window.FlutterGetSavedLocations.postMessage('');
    }
  }, []);

  const handleSearchSelect = (location) => {
    setSelectedLocation(location);
    setIsHoursExpanded(false);
    setSearchQuery(''); 
    setSearchResults([]);
    if (mapRef.current) {
      const viewportWidth = mapRef.current.clientWidth || 400;
      const viewportHeight = mapRef.current.clientHeight || 600;
      const newViewState = window.MapService.calculateViewForLocation(location, { 
        viewportWidth,
        viewportHeight,
        scale: viewState.scale 
      });
      setViewState(newViewState);
    }
  };

  const getEventPos = (e) => {
    if (e.touches && e.touches.length > 0) {
      return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
    return { x: e.clientX, y: e.clientY };
  };

  const handleStart = (e) => {
    e.preventDefault();
    const pos = getEventPos(e);
    setIsDragging(true);
    // Store the initial mouse/touch position and current view state
    // dragStart will be used to calculate the offset during dragging
    setDragStart({ 
      x: pos.x - viewState.x, 
      y: pos.y - viewState.y 
    });
    touchStartRef.current = pos;
  };

  const handleMove = (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const pos = getEventPos(e);
    setViewState(prev => ({
      ...prev,
      x: pos.x - dragStart.x,
      y: pos.y - dragStart.y
    }));
  };

  const handleEnd = () => {
    setIsDragging(false);
    touchStartRef.current = null;
  };

  const handleZoom = (direction) => {
    if (!mapRef.current) return;
    setViewState(prev => {
      const viewportWidth = mapRef.current.clientWidth || 400;
      const viewportHeight = mapRef.current.clientHeight || 600;
      const viewportCenterX = viewportWidth / 2;
      const viewportCenterY = viewportHeight / 2;
      const mapPointX = (viewportCenterX - prev.x) / prev.scale;
      const mapPointY = (viewportCenterY - prev.y) / prev.scale;
      const newScale = window.MapService.calculateZoom(prev.scale, direction);
      const newX = viewportCenterX - (mapPointX * newScale);
      const newY = viewportCenterY - (mapPointY * newScale);
      return { ...prev, scale: newScale, x: newX, y: newY };
    });
  };

  const handlePinClick = (e) => {
    e.stopPropagation();
  };

  const closeSheet = () => {
    setSelectedLocation(null);
    setIsHoursExpanded(false);
  };

  const toggleHours = () => {
    setIsHoursExpanded(!isHoursExpanded);
  };

  const handleSaveToggle = () => {
    if (!selectedLocation) return;
    const isCurrentlySaved = savedLocations.has(selectedLocation.id);
    
    // Update local state immediately for UI responsiveness
    setSavedLocations(prev => {
      const newSet = new Set(prev);
      if (isCurrentlySaved) {
        newSet.delete(selectedLocation.id);
        // Notify Flutter to unsave in Firebase
        if (window.FlutterUnsaveLocation) {
          window.FlutterUnsaveLocation.postMessage(selectedLocation.id);
        }
      } else {
        newSet.add(selectedLocation.id);
        // Notify Flutter to save in Firebase
        if (window.FlutterSaveLocation) {
          window.FlutterSaveLocation.postMessage(selectedLocation.id);
        }
      }
      return newSet;
    });
  };

  const handleSendSceneClick = () => {
    setSelectedFriends(new Set());
    setIsSendSceneModalOpen(true);
  };

  const handleFriendToggle = (friendId) => {
    setSelectedFriends(prev => {
      const newSet = new Set(prev);
      if (newSet.has(friendId)) {
        newSet.delete(friendId);
      } else {
        newSet.add(friendId);
      }
      return newSet;
    });
  };

  const handleSendScene = () => {
    setIsSendSceneModalOpen(false);
    setSelectedFriends(new Set());
  };

  // Allow Flutter to open a specific location by ID using the same modal logic
  useEffect(() => {
    window.openLocationFromFlutter = (locationId) => {
      if (!locationId || !window.LOCATION_DATABASE) return;
      const location = window.LOCATION_DATABASE.find((loc) => loc.id === locationId);
      if (!location) return;

      setSelectedLocation(location);
      setIsHoursExpanded(false);

      if (mapRef.current) {
        const viewportWidth = mapRef.current.clientWidth || 400;
        const viewportHeight = mapRef.current.clientHeight || 600;
        const newViewState = window.MapService.calculateViewForLocation(location, {
          viewportWidth,
          viewportHeight,
          scale: viewState.scale,
        });
        setViewState(newViewState);
      }
    };

    return () => {
      window.openLocationFromFlutter = null;
    };
  }, [viewState.scale]);

  const handleCancelSendScene = () => {
    setIsSendSceneModalOpen(false);
    setSelectedFriends(new Set());
  };

  const handleAddressClick = (address) => {
    if (!address) return;
    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    window.open(googleMapsUrl, '_blank', 'noopener,noreferrer');
  };

  return (
    <div style={{ width: '100%', height: '100vh', overflow: 'hidden', margin: 0, padding: 0 }}>
      <div style={{ 
        position: 'relative', 
        width: '100%', 
        height: '100%', 
        backgroundColor: '#E5E3DF',
        overflow: 'hidden',
        touchAction: 'none'
      }}>
        <div 
          ref={mapRef}
          style={{
            width: '100%',
            height: '100%',
            position: 'relative',
            overflow: 'hidden',
            touchAction: 'none',
            backgroundColor: '#E5E3DF'
          }}
          onMouseDown={handleStart}
          onMouseMove={handleMove}
          onMouseUp={handleEnd}
          onMouseLeave={handleEnd}
          onTouchStart={handleStart}
          onTouchMove={handleMove}
          onTouchEnd={handleEnd}
        >
          <div 
            style={{ 
              position: 'absolute',
              transform: `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})`,
              transformOrigin: '0 0',
              width: '3000px', 
              height: '3000px',
              willChange: 'transform',
              overflow: 'visible'
            }}
          >
            {isLoadingOSM ? (
              <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', color: '#64748b', fontSize: '14px' }}>
                Loading map data...
              </div>
            ) : (
              <svg 
                width="3000" 
                height="3000" 
                viewBox="0 0 3000 3000" 
                style={{ 
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  pointerEvents: 'none',
                  zIndex: 1
                }}
              >
                <defs>
                  <pattern id="cityGrid" width="20" height="20" patternUnits="userSpaceOnUse" patternTransform="rotate(-15)">
                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#d9d7d3" strokeWidth="0.8"/>
                  </pattern>
                </defs>
                <rect width="3000" height="3000" fill="#E5E3DF" />
                <rect width="3000" height="3000" fill="url(#cityGrid)" />
                {/* OSM Rendered Elements */}
                {osmSvgElements}
              </svg>
            )}

            <div style={{ position: 'absolute', top: '1850px', left: '1200px', fontSize: '32px', fontWeight: '900', color: 'rgba(71, 85, 105, 0.25)', textTransform: 'uppercase', letterSpacing: '0.15em', transform: 'rotate(-8deg)', pointerEvents: 'none', fontFamily: 'Arial, sans-serif' }}>Downtown</div>
            <div style={{ position: 'absolute', top: '2150px', left: '1600px', fontSize: '26px', fontWeight: '900', color: 'rgba(71, 85, 105, 0.25)', textTransform: 'uppercase', letterSpacing: '0.15em', transform: 'rotate(-8deg)', pointerEvents: 'none', fontFamily: 'Arial, sans-serif' }}>Old Port</div>
            <div style={{ position: 'absolute', top: '1350px', left: '1700px', fontSize: '30px', fontWeight: '900', color: 'rgba(71, 85, 105, 0.25)', textTransform: 'uppercase', letterSpacing: '0.15em', transform: 'rotate(-8deg)', pointerEvents: 'none', fontFamily: 'Arial, sans-serif' }}>Plateau</div>

            {window.LOCATION_DATABASE.map((loc) => {
              const markerColor = window.MapService.getMarkerColor(loc.type);
              const borderColor = window.MapService.getMarkerBorderColor(loc.type);
              const isSelected = selectedLocation?.id === loc.id;
              const inverseScale = 1 / viewState.scale;
              const pinSize = 20 * inverseScale;
              const iconSize = 10 * inverseScale;
              const borderWidth = 1.5 * inverseScale;
              const needleSize = 3 * inverseScale;
              const needleTop = 4 * inverseScale;
              const isZoomedIn = viewState.scale > 0.7;
              const showLabel = viewState.scale > 0.5; // Hide labels when zoomed out more than halfway
              
              return (
                <div 
                  key={loc.id}
                  style={{ 
                    position: 'absolute',
                    left: loc.coordinates.x,
                    top: loc.coordinates.y,
                    transform: 'translate(-50%, -100%)',
                    zIndex: isSelected ? 1000 : 100,
                    cursor: 'pointer',
                    pointerEvents: 'auto',
                    overflow: 'visible'
                  }}
                  onClick={(e) => {
                    e.stopPropagation();
                    setSelectedLocation(loc);
                  }}
                >
                  <div style={{ position: 'relative', display: 'flex', flexDirection: 'column', alignItems: 'center', overflow: 'visible', zIndex: isSelected ? 1000 : 100 }}>
                    <div 
                      style={{
                        width: `${pinSize}px`,
                        height: `${pinSize}px`,
                        borderRadius: '50%',
                        backgroundColor: isSelected ? '#2563eb' : markerColor.includes('orange') ? '#f97316' : markerColor.includes('purple') ? '#a855f7' : markerColor.includes('pink') ? '#ec4899' : markerColor.includes('indigo') ? '#6366f1' : markerColor.includes('teal') ? '#14b8a6' : markerColor.includes('green') ? '#16a34a' : '#ef4444',
                        border: `${borderWidth}px solid white`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        transform: isSelected ? 'scale(1.25)' : 'scale(1)',
                        transition: 'transform 0.2s'
                      }}
                    >
                      {loc.type === 'restaurant' || loc.type === 'food' ? 
                        <Utensils style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                       loc.type === 'bar' ? 
                        <Beer style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                       loc.type === 'shop' ? 
                        <ShoppingBag style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                       loc.type === 'hotel' ? 
                        <Hotel style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                       loc.type === 'landmark' || loc.type === 'attraction' ? 
                        <Landmark style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                       loc.type === 'park' ? 
                        <MapPin style={{ width: `${iconSize}px`, height: `${iconSize}px`, color: 'white' }} /> :
                        <div style={{ width: `${iconSize * 0.5}px`, height: `${iconSize * 0.5}px`, backgroundColor: 'white', borderRadius: '50%' }} />
                      }
                    </div>
                    <div 
                      style={{
                        width: 0,
                        height: 0,
                        borderLeft: `${needleSize}px solid transparent`,
                        borderRight: `${needleSize}px solid transparent`,
                        borderTop: `${needleTop}px solid ${isSelected ? '#2563eb' : (borderColor.includes('orange') ? '#f97316' : borderColor.includes('purple') ? '#a855f7' : borderColor.includes('pink') ? '#ec4899' : borderColor.includes('indigo') ? '#6366f1' : borderColor.includes('teal') ? '#14b8a6' : borderColor.includes('green') ? '#16a34a' : '#ef4444')}`,
                        marginTop: '-2px'
                      }}
                    />
                    {showLabel && (
                      <div 
                        style={{
                          position: 'absolute',
                          top: '100%',
                          left: '50%',
                          transform: 'translateX(-50%)',
                          marginTop: `${Math.max(4, 4 * inverseScale)}px`,
                          padding: `${Math.max(3, 3 * inverseScale)}px ${Math.max(6, 6 * inverseScale)}px`,
                          backgroundColor: 'rgba(255, 255, 255, 0.95)',
                          borderRadius: `${Math.max(4, 4 * inverseScale)}px`,
                          fontSize: `${Math.max(10, 10 * inverseScale)}px`,
                          fontWeight: '500',
                          whiteSpace: 'nowrap',
                          color: '#1e293b',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.12)',
                          border: '1px solid rgba(0, 0, 0, 0.1)',
                          pointerEvents: 'none',
                          fontFamily: 'Arial, sans-serif',
                          lineHeight: '1.2',
                          opacity: 1,
                          zIndex: 9999
                        }}
                      >
                        {loc.name}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {!selectedLocation && (
          <div style={{ position: 'absolute', top: '16px', left: '16px', right: '16px', zIndex: 30 }}>
            <div style={{ backgroundColor: 'white', borderRadius: '9999px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '12px', display: 'flex', alignItems: 'center', gap: '12px', border: '1px solid #f1f5f9' }}>
              <Search style={{ width: '20px', height: '20px', color: '#64748b', marginLeft: '4px' }} />
              <input 
                type="text" 
                placeholder="Search Montreal..." 
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                style={{ flex: 1, backgroundColor: 'transparent', border: 'none', outline: 'none', color: '#1e293b', fontSize: '14px' }}
              />
              {searchQuery && (
                <button onClick={() => setSearchQuery('')} style={{ padding: '4px', backgroundColor: 'transparent', border: 'none', cursor: 'pointer' }}>
                  <X style={{ width: '16px', height: '16px', color: '#94a3b8' }} />
                </button>
              )}
            </div>

            {searchQuery && searchResults.length > 0 && (
               <div style={{ backgroundColor: 'white', borderRadius: '16px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', border: '1px solid #f1f5f9', overflow: 'hidden', marginTop: '8px', maxHeight: '60vh', overflowY: 'auto' }}>
                 {searchResults.map((loc) => (
                   <div 
                     key={loc.id} 
                     onClick={() => handleSearchSelect(loc)}
                     style={{ padding: '16px', display: 'flex', alignItems: 'center', gap: '12px', borderBottom: '1px solid #f8fafc', cursor: 'pointer' }}
                   >
                     <div style={{ width: '40px', height: '40px', borderRadius: '50%', backgroundColor: '#f1f5f9', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <MapPin style={{ width: '20px', height: '20px', color: '#64748b' }} />
                     </div>
                     <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                       <span style={{ fontWeight: '500', color: '#0f172a', fontSize: '14px' }}>{loc.name}</span>
                       <span style={{ fontSize: '12px', color: '#64748b' }}>{loc.category} • {loc.distance}</span>
                     </div>
                   </div>
                 ))}
               </div>
            )}
          </div>
        )}

        <div style={{ position: 'absolute', right: '16px', bottom: '96px', display: 'flex', flexDirection: 'column', gap: '8px', zIndex: 20 }}>
          <button 
            onClick={() => handleZoom('in')} 
            style={{ width: '44px', height: '44px', backgroundColor: 'white', borderRadius: '50%', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '1px solid #f1f5f9', cursor: 'pointer' }}
          >
            <Plus style={{ width: '20px', height: '20px', color: '#475569' }} />
          </button>
          <button 
            onClick={() => handleZoom('out')} 
            style={{ width: '44px', height: '44px', backgroundColor: 'white', borderRadius: '50%', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '1px solid #f1f5f9', cursor: 'pointer' }}
          >
            <Minus style={{ width: '20px', height: '20px', color: '#475569' }} />
          </button>
        </div>

        <div style={{ position: 'absolute', bottom: '8px', left: '50%', transform: 'translateX(-50%)', zIndex: 10, pointerEvents: 'none' }}>
          <div style={{ fontSize: '10px', fontWeight: '500', fontFamily: 'Roboto, Arial, sans-serif', color: '#428fdf' }}>Alki Corp. Maps™</div>
        </div>

        {selectedLocation && (
          <div style={{ position: 'absolute', inset: 0, zIndex: 30, display: 'flex', flexDirection: 'column', justifyContent: 'flex-end' }}>
            <div style={{ position: 'absolute', inset: 0, backgroundColor: 'rgba(0, 0, 0, 0.1)' }} />
            <div style={{ position: 'relative', backgroundColor: 'white', width: '100%', borderTopLeftRadius: '24px', borderTopRightRadius: '24px', boxShadow: '0 -5px 20px rgba(0,0,0,0.1)', maxHeight: '75%', overflowY: 'auto' }}>
              <div style={{ width: '100%', display: 'flex', justifyContent: 'center', paddingTop: '12px', paddingBottom: '4px' }}>
                <div style={{ width: '48px', height: '6px', backgroundColor: '#cbd5e1', borderRadius: '9999px' }} />
              </div>
              <div style={{ padding: '20px', paddingTop: '8px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '4px' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#1e293b', paddingRight: '8px' }}>{selectedLocation.name}</h2>
                  <button 
                    onClick={closeSheet}
                    style={{ padding: '6px', backgroundColor: '#f1f5f9', borderRadius: '50%', border: 'none', cursor: 'pointer' }}
                  >
                    <X style={{ width: '20px', height: '20px', color: '#64748b' }} />
                  </button>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
                  <span style={{ fontWeight: 'bold', fontSize: '14px', color: '#1e293b' }}>{selectedLocation.rating}</span>
                  <div style={{ display: 'flex', color: '#fbbf24' }}>
                    {[...Array(5)].map((_, i) => (
                      <Star key={i} style={{ width: '14px', height: '14px', fill: i < Math.floor(selectedLocation.rating) ? 'currentColor' : '#e2e8f0', color: i < Math.floor(selectedLocation.rating) ? 'currentColor' : '#e2e8f0' }} />
                    ))}
                  </div>
                  <span style={{ color: '#64748b', fontSize: '14px' }}>({selectedLocation.reviews} reviews)</span>
                  <span style={{ color: '#cbd5e1', fontSize: '12px' }}>•</span>
                  <span style={{ color: '#64748b', fontSize: '14px' }}>{selectedLocation.category}</span>
                  {selectedLocation.price && (
                    <>
                      <span style={{ color: '#cbd5e1', fontSize: '12px' }}>•</span>
                      <span style={{ color: '#64748b', fontSize: '14px' }}>{selectedLocation.price}</span>
                    </>
                  )}
                </div>
                <p style={{ fontSize: '14px', color: '#475569', lineHeight: '1.6', marginBottom: '24px' }}>
                  {selectedLocation.description}
                </p>
                <div style={{ display: 'flex', gap: '16px', marginBottom: '24px' }}>
                  <button 
                    onClick={handleSaveToggle}
                    style={{ 
                      flex: 1,
                      minWidth: '90px',
                      padding: '10px 16px',
                      borderRadius: '9999px',
                      fontWeight: '500',
                      fontSize: '14px',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '4px',
                      border: savedLocations.has(selectedLocation.id) ? '2px solid #16a34a' : '2px solid #e2e8f0',
                      backgroundColor: savedLocations.has(selectedLocation.id) ? '#f0fdf4' : '#f8fafc',
                      color: savedLocations.has(selectedLocation.id) ? '#15803d' : '#475569',
                      cursor: 'pointer'
                    }}
                  >
                    <Bookmark style={{ width: '20px', height: '20px', fill: savedLocations.has(selectedLocation.id) ? '#16a34a' : 'none', color: savedLocations.has(selectedLocation.id) ? '#16a34a' : '#475569' }} />
                    <span>Save</span>
                  </button>
                  <button 
                    onClick={handleSendSceneClick}
                    style={{ 
                      flex: 1,
                      minWidth: '90px',
                      padding: '10px 16px',
                      borderRadius: '9999px',
                      fontWeight: '500',
                      fontSize: '14px',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '4px',
                      border: '2px solid #e2e8f0',
                      backgroundColor: '#f8fafc',
                      color: '#475569',
                      cursor: 'pointer'
                    }}
                  >
                    <Share2 style={{ width: '20px', height: '20px' }} />
                    <span>Send Scene™</span>
                  </button>
                </div>
                <div style={{ height: '1px', backgroundColor: '#f1f5f9', width: '100%', marginBottom: '16px' }} />
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                    <MapPin style={{ width: '20px', height: '20px', color: '#2563eb', marginTop: '2px', flexShrink: 0 }} />
                    <button
                      onClick={() => handleAddressClick(selectedLocation.address)}
                      style={{ fontSize: '14px', color: '#334155', textAlign: 'left', backgroundColor: 'transparent', border: 'none', cursor: 'pointer', padding: 0 }}
                    >
                      {selectedLocation.address}
                    </button>
                  </div>
                  <div>
                    <button
                      onClick={toggleHours}
                      style={{ width: '100%', display: 'flex', alignItems: 'flex-start', gap: '12px', textAlign: 'left', backgroundColor: 'transparent', border: 'none', cursor: 'pointer', padding: '4px 0' }}
                    >
                      <Clock style={{ width: '20px', height: '20px', color: '#2563eb', marginTop: '2px', flexShrink: 0 }} />
                      <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap', fontSize: '14px' }}>
                          <span style={{ fontWeight: '500', color: selectedLocation.openStatus?.includes('Open') ? '#16a34a' : selectedLocation.openStatus?.includes('Closed') ? '#ef4444' : '#f97316' }}>
                            {selectedLocation.openStatus || 'Hours not available'}
                          </span>
                          {selectedLocation.closeTime && (
                            <span style={{ color: '#64748b' }}>⋅ Closes {selectedLocation.closeTime}</span>
                          )}
                        </div>
                        <ChevronDown style={{ width: '16px', height: '16px', color: '#94a3b8', flexShrink: 0, transform: isHoursExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                      </div>
                    </button>
                    {isHoursExpanded && selectedLocation.hours && Array.isArray(selectedLocation.hours) && (
                      <div style={{ marginLeft: '32px', display: 'flex', flexDirection: 'column', gap: '6px', paddingTop: '4px', paddingBottom: '4px' }}>
                        {selectedLocation.hours.map((dayData) => {
                          const isToday = currentDay === dayData.day;
                          return (
                            <div key={dayData.day} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px', fontWeight: isToday ? '600' : '400', color: isToday ? '#0f172a' : '#475569' }}>
                              <span style={{ width: '112px' }}>{dayData.day}</span>
                              <span>{dayData.time}</span>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                    <Globe style={{ width: '20px', height: '20px', color: '#2563eb', marginTop: '2px', flexShrink: 0 }} />
                    <a 
                      href={`https://www.${selectedLocation.name.toLowerCase().replace(/['\s]/g, '')}.com`}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ fontSize: '14px', color: '#334155', textAlign: 'left', textDecoration: 'none' }}
                    >
                      www.{selectedLocation.name.toLowerCase().replace(/['\s]/g, '')}.com
                    </a>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                    <Phone style={{ width: '20px', height: '20px', color: '#2563eb', marginTop: '2px', flexShrink: 0 }} />
                    <a 
                      href="tel:+15145550199"
                      style={{ fontSize: '14px', color: '#334155', textAlign: 'left', textDecoration: 'none' }}
                    >
                      (514) 555-0199
                    </a>
                  </div>
                </div>
                <div style={{ marginTop: '24px' }}>
                  <h3 style={{ fontWeight: 'bold', color: '#1e293b', marginBottom: '12px' }}>Photos</h3>
                  <div style={{ display: 'flex', gap: '8px', overflowX: 'auto', height: '128px', paddingBottom: '8px' }}>
                    <div style={{ width: '128px', height: '100%', backgroundColor: '#e2e8f0', borderRadius: '12px', flexShrink: 0 }} />
                    <div style={{ width: '128px', height: '100%', backgroundColor: '#e2e8f0', borderRadius: '12px', flexShrink: 0 }} />
                    <div style={{ width: '128px', height: '100%', backgroundColor: '#e2e8f0', borderRadius: '12px', flexShrink: 0 }} />
                  </div>
                </div>
                <div style={{ height: '32px' }} />
              </div>
            </div>
          </div>
        )}

        {isSendSceneModalOpen && (
          <div 
            style={{ position: 'absolute', inset: 0, zIndex: 40, display: 'flex', alignItems: 'center', justifyContent: 'center' }}
            onClick={(e) => {
              if (e.target === e.currentTarget) {
                handleCancelSendScene();
              }
            }}
          >
            <div style={{ position: 'absolute', inset: 0, backgroundColor: 'rgba(0, 0, 0, 0.4)' }} />
            <div 
              style={{ position: 'relative', backgroundColor: 'white', width: '100%', maxWidth: '28rem', margin: '0 16px', borderRadius: '24px', boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)', maxHeight: '80vh', display: 'flex', flexDirection: 'column' }}
              onClick={(e) => e.stopPropagation()}
            >
              <div style={{ padding: '24px', borderBottom: '1px solid #f1f5f9' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#1e293b' }}>Send Scene™</h2>
                  <button 
                    onClick={handleCancelSendScene}
                    style={{ padding: '6px', backgroundColor: '#f1f5f9', borderRadius: '50%', border: 'none', cursor: 'pointer' }}
                  >
                    <X style={{ width: '20px', height: '20px', color: '#64748b' }} />
                  </button>
                </div>
                <p style={{ fontSize: '14px', color: '#64748b', marginTop: '4px' }}>Select friends to share with</p>
              </div>
              <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {friendsList.map((friend) => {
                  const isSelected = selectedFriends.has(friend.id);
                  return (
                    <button
                      key={friend.id}
                      onClick={() => handleFriendToggle(friend.id)}
                      style={{
                        width: '100%',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        padding: '12px',
                        borderRadius: '12px',
                        border: isSelected ? '2px solid #2563eb' : '2px solid transparent',
                        backgroundColor: isSelected ? '#eff6ff' : '#f8fafc',
                        cursor: 'pointer'
                      }}
                    >
                      <div style={{
                        width: '48px',
                        height: '48px',
                        borderRadius: '50%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontWeight: '600',
                        fontSize: '14px',
                        flexShrink: 0,
                        backgroundColor: isSelected ? '#2563eb' : '#cbd5e1',
                        color: isSelected ? 'white' : '#475569'
                      }}>
                        {friend.avatar}
                      </div>
                      <div style={{ flex: 1, textAlign: 'left' }}>
                        <div style={{ fontWeight: '500', color: '#1e293b' }}>{friend.name}</div>
                      </div>
                      <div style={{
                        width: '24px',
                        height: '24px',
                        borderRadius: '50%',
                        border: `2px solid ${isSelected ? '#2563eb' : '#cbd5e1'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0,
                        backgroundColor: isSelected ? '#2563eb' : 'transparent'
                      }}>
                        {isSelected && (
                          <svg style={{ width: '16px', height: '16px', color: 'white' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                          </svg>
                        )}
                      </div>
                    </button>
                  );
                })}
              </div>
              <div style={{ padding: '16px', borderTop: '1px solid #f1f5f9', display: 'flex', gap: '12px' }}>
                <button
                  onClick={handleCancelSendScene}
                  style={{ flex: 1, padding: '12px 16px', backgroundColor: 'white', border: '2px solid #e2e8f0', color: '#334155', borderRadius: '12px', fontWeight: '500', cursor: 'pointer' }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleSendScene}
                  disabled={selectedFriends.size === 0}
                  style={{ flex: 1, padding: '12px 16px', backgroundColor: selectedFriends.size === 0 ? '#94a3b8' : '#2563eb', color: 'white', borderRadius: '12px', fontWeight: '500', cursor: selectedFriends.size === 0 ? 'not-allowed' : 'pointer', border: 'none' }}
                >
                  Send {selectedFriends.size > 0 && `(${selectedFriends.size})`}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

window.App = App;

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
    </script>
  </body>
</html>
